{% extends 'app/base.html' %}
{% load static %}
{% block title %}Home{% endblock title %}

{% block main-content %}
<div class="container-fluid" style="background:#f5f6fa;min-height:100vh;">
  <div class="row">
    <!-- Sidebar Categories -->
    <div class="col-md-2 d-none d-md-block" style="background:#fff;min-height:100vh;border-right:1px solid #eee;">
      <h5 class="mt-4 mb-3" style="color:#222;font-weight:bold;">CATEGORIES</h5>
      <ul class="list-group list-group-flush">
        {% for cat in main_categories %}
          <li class="list-group-item">
            <a href="{% url 'category' cat.name %}">{{ cat.name }}</a>
          </li>
        {% endfor %}
      </ul>
    </div>
    <!-- Main Content -->
    <div class="col-md-10">
      <!-- Banner -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card mb-4" style="background:#fff;">
            <div class="row g-0 align-items-center">
              <div class="col-md-8 p-4">
                <h2 style="font-weight:bold;color:#222;">WOMEN <span style="color:#f7b731;">FASHION</span></h2>
                <p style="color:#555;">Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit.</p>
                <a href="#" class="btn btn-primary">Shop Now</a>
              </div>
              <div class="col-md-4 text-center">
                <img src="https://i.imgur.com/1Q9Z1Zm.png" alt="Fashion Banner" style="max-width:100%;height:180px;object-fit:contain;">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Info Bar -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card text-center" style="background:#2e86de;color:#fff;">
            <div class="card-body p-3">MONEY BACK<br><small>30 Days Money Back Guarantee</small></div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center" style="background:#00b894;color:#fff;">
            <div class="card-body p-3">FREE SHIPPING<br><small>Shipping on orders over $99</small></div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center" style="background:#fdcb6e;color:#222;">
            <div class="card-body p-3">SPECIAL SALE<br><small>Extra 5% off on all items</small></div>
          </div>
        </div>
      </div>
      <!-- Hot Deals -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-header bg-danger text-white">HOT DEALS</div>
            <div class="card-body text-center">
              <img src="https://i.imgur.com/8Km9tLL.png" alt="Hot Deal" style="width:80px;height:80px;object-fit:cover;">
              <h6 class="mt-2">Floral Print Buttoned</h6>
              <div class="mb-2"><span class="badge bg-warning text-dark">20% OFF</span></div>
              <div><b>$500.00</b> <span class="text-muted text-decoration-line-through">$600.00</span></div>
              <button class="btn btn-sm btn-primary mt-2">Add to cart</button>
        </div>
    </div>
</div>
        <!-- You can loop more hot deals here -->
</div>
      <!-- New Products -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="mb-3" style="font-weight:bold;">NEW PRODUCTS</h5>
    <div class="row">
      {% for product in new_products %}
      <div class="col-md-3 mb-4">
        <div class="card h-100">
          <img src="{{ product.product_image.url }}" class="card-img-top" alt="{{ product.title }}" style="object-fit:cover;height:200px;">
          <div class="card-body">
            <h6 class="card-title">{{ product.title }}</h6>
            <div class="mb-2"><span class="badge bg-info text-dark">New</span></div>
            <div><b>â‚¹{{ product.discounted_price }}</b></div>
            <a href="{% url 'product-detail' product.id %}" class="btn btn-sm btn-outline-primary mt-2">View Product</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
</div>
      </div>
    </div>
  </div>
</div>

<!-- ShopGenie Floating Chatbot Widget -->
<div id="shopgenie-chatbot" class="chatbot-widget">
  <div class="chatbot-header">
    <span class="bot-avatar">ðŸ¤–</span>
    <span class="bot-name">ShopGenie</span>
    <span class="bot-status">Online Now</span>
  </div>
  <div id="chatbot-messages" class="chatbot-messages"></div>
  <form id="chatbot-form" class="chatbot-form">
    <input type="text" id="chatbot-input" placeholder="Type your message..." autocomplete="off" />
    <button type="submit">Send</button>
  </form>
</div>
<style>
.chatbot-widget {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 350px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(80,0,120,0.15);
  font-family: 'Segoe UI', sans-serif;
  z-index: 1000;
  overflow: hidden;
}
.chatbot-header {
  background: #a259f7;
  color: #fff;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.bot-avatar {
  font-size: 2em;
}
.bot-name {
  font-weight: bold;
  font-size: 1.1em;
}
.bot-status {
  margin-left: auto;
  font-size: 0.9em;
  opacity: 0.8;
}
.chatbot-messages {
  max-height: 350px;
  overflow-y: auto;
  padding: 16px;
  background: #f7f5fa;
}
.chatbot-message {
  margin-bottom: 16px;
  display: flex;
  flex-direction: column;
}
.chatbot-message.bot {
  align-items: flex-start;
}
.chatbot-message.user {
  align-items: flex-end;
}
.chatbot-bubble {
  padding: 10px 16px;
  border-radius: 18px;
  max-width: 80%;
  font-size: 1em;
  margin-bottom: 4px;
}
.chatbot-bubble.bot {
  background: #e5d8fa;
  color: #4b2e83;
  border-bottom-left-radius: 4px;
}
.chatbot-bubble.user {
  background: #a259f7;
  color: #fff;
  border-bottom-right-radius: 4px;
}
.chatbot-form {
  display: flex;
  border-top: 1px solid #eee;
  padding: 10px;
  background: #fff;
}
#chatbot-input {
  flex: 1;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 1em;
  outline: none;
}
.chatbot-form button {
  background: #a259f7;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  margin-left: 8px;
  cursor: pointer;
  font-weight: bold;
}
</style>
<script>
// ShopGenie Chatbot Widget Logic
const messagesDiv = document.getElementById('chatbot-messages');
const form = document.getElementById('chatbot-form');
const input = document.getElementById('chatbot-input');
function addMessage(text, sender='bot') {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'chatbot-message ' + sender;
  const bubble = document.createElement('div');
  bubble.className = 'chatbot-bubble ' + sender;
  bubble.innerHTML = text;
  msgDiv.appendChild(bubble);
  messagesDiv.appendChild(msgDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
// Initial greeting
addMessage("Hi! I'm ShopGenie ðŸ¤–. How can I help you today?");
form.onsubmit = async function(e) {
  e.preventDefault();
  const userText = input.value.trim();
  if (!userText) return;
  addMessage(userText, 'user');
  input.value = '';
  // Send to Django backend (assistant endpoint)
  const response = await fetch(window.location.pathname, {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}'},
    body: 'query=' + encodeURIComponent(userText)
  });
  const html = await response.text();
  // Parse the latest assistant response from the returned HTML
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const currentBox = doc.querySelector('.current-response-box .mt-2');
  if (currentBox) {
    addMessage(currentBox.innerText, 'bot');
  } else {
    // fallback: try to extract from the page body
    const bodyText = doc.body ? doc.body.innerText.trim() : '';
    if (bodyText) {
      addMessage(bodyText, 'bot');
    } else {
      addMessage('Sorry, I could not understand that.', 'bot');
    }
  }
};
</script>
{% endblock %}


